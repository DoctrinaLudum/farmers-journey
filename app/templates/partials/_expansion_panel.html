<div class="row g-4">
    <div class="col-lg-4">
        <div class="card dashboard-card h-100">
            <div class="card-header"><i class="bi bi-pin-map-fill me-1"></i> Você está aqui</div>
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center">
                    <div class="display-4 fw-bold text-success me-3">{{ current_land_level or 'N/A' }}</div>
                    <div>
                        <h6 class="card-title mb-0">Ilha {{ current_land_type|title }}</h6>
                        <small class="text-muted">Nível de Expansão</small>
                        <div class="border-top mt-2 pt-2">
                            <small class="text-muted"><i class="bi bi-person-walking me-1"></i>Nv: <strong>{{ bumpkin_level or 'N/A' }}</strong></small>
                        </div>
                    </div>
                </div>

                {% if expansion_construction_info %}
                <div class="expansion-timer-card d-flex align-items-center">
                    <div class="timer-icon me-2">
                        {% if expansion_construction_info.is_complete %}
                            <div class="completed-icon-stack">
                                <img src="{{ url_for('static', filename='images/misc/land_complete.webp') }}" alt="Expansão completa" class="stack-layer base-layer">
                                <img src="{{ url_for('static', filename='images/misc/disc.webp') }}" alt="Círculo" class="stack-layer middle-layer">
                                <img src="{{ url_for('static', filename='images/misc/confirm.webp') }}" alt="Confirmar" class="stack-layer top-layer-animated">
                            </div>
                        {% else %}
                            <img src="{{ url_for('static', filename='images/misc/construct.webp') }}" alt="Construção" class="construction-gif-timer">
                        {% endif %}
                    </div>
                    <div class="timer-details flex-grow-1">
                        {% if expansion_construction_info.is_complete %}
                            <div class="timer-title">Expansão para o Nível {{ expansion_construction_info.target_level }}</div>
                            <div class="countdown-time text-success">Concluída!</div>
                        {% else %}
                            <div class="timer-title">Expansão para o Nível {{ expansion_construction_info.target_level }} em andamento!</div>
                            <div id="countdown-timer" class="countdown-time" data-ready-at="{{ expansion_construction_info.readyAt }}">Calculando...</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if current_level_nodes %}
                <div class="level-nodes-container flex-grow-1">
                    <h6 class="nodes-title">Recursos Totais na Expansão</h6>
                    <table class="table table-sm table-borderless mb-0">
                        <tbody>
                            {% for node in current_level_nodes %}
                            <tr>
                                <td style="width: 40px;" class="text-center">
                                    <img src="{{ url_for('static', filename=get_item_image_path(node.name)) }}" alt="{{ node.name }}" class="list-icon" onerror="this.style.display='none'">
                                </td>
                                <td class="small align-middle">{{ node.name }}</td>
                                <td class="text-end" style="width: 40px;">
                                    <span class="badge bg-secondary-subtle text-dark-emphasis rounded-pill">{{ node.count }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card dashboard-card h-100">
            <div class="card-header"><i class="bi bi-compass me-1"></i> Planejador de Expansão</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-7 border-end-lg-custom">
                        <div class="pe-lg-3">
                            <h6 class="mb-2 fw-bold">Simulador de Meta</h6>
                            <form id="goal-form" class="d-flex gap-2" data-farm-id="{{ farm_id }}" data-current-land-type="{{ current_land_type }}" data-current-level="{{ current_land_level }}">
                                <select class="form-select" id="goal_level" name="goal_level">
                                    <option selected disabled value="">Selecione um nível...</option>
                                    {% for island, levels in expansion_goals.items() %}
                                        <optgroup label="Ilha {{ island|title }}">
                                            {% for level in levels %}
                                                <option value="{{ island }}-{{ level }}">Nível {{ level }}</option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-primary flex-shrink-0">Definir</button>
                            </form>
                            <div id="goal-results-container" class="mt-3">
                                <div class="text-center text-muted p-3">
                                    <h5 class="text-dark">Bem-vindo ao Planejador de Expansão!</h5>
                                    <p class="small">Esta é a sua central de comando para o crescimento da sua ilha.</p>
                                    
                                    <div class="row mt-4 text-start">
                                        <div class="col-lg-4">
                                            <div class="d-flex">
                                                <i class="bi bi-pin-map-fill me-2 fs-4 text-success"></i>
                                                <div>
                                                    <strong>Você está aqui</strong>
                                                    <p class="small mb-0">À esquerda, veja seu nível atual, nodes de recursos totais e o tempo de qualquer expansão em andamento.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="d-flex mt-3 mt-lg-0">
                                                <i class="bi bi-bullseye me-2 fs-4 text-primary"></i>
                                                <div>
                                                    <strong>Simulador de Meta</strong>
                                                    <p class="small mb-0">Use o seletor acima para calcular os custos e o tempo para alcançar qualquer nível futuro.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="d-flex mt-3 mt-lg-0">
                                                <i class="bi bi-map me-2 fs-4 text-warning"></i>
                                                <div>
                                                    <strong>Mapa Interativo</strong>
                                                    <p class="small mb-0">À direita, explore o mapa, filtre por ilha e posicione o ponteiro sobre os lotes para ver detalhes.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5 mt-4 mt-lg-0">
                        <div class="ps-lg-3">
                            <div class="map-controls">
                                <h6 class="mb-2 fw-bold">Mapa de Expansão</h6>
                                <!-- NOVO: Abas de Navegação Bootstrap -->
                                <ul class="nav nav-pills nav-fill nav-justified btn-group btn-group-sm w-100" id="map-filter-tabs" role="tablist">
                                    {% for island_name in plots_by_island.keys() %}
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link btn btn-outline-secondary {% if island_name == current_land_type %}active{% endif %}" id="map-tab-{{ island_name }}" data-bs-toggle="tab" data-bs-target="#map-pane-{{ island_name }}" type="button" role="tab" aria-controls="map-pane-{{ island_name }}" aria-selected="{% if island_name == current_land_type %}true{% else %}false{% endif %}">
                                                {{ island_name|title }}
                                            </button>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <!-- NOVO: Conteúdo das Abas -->
                            <div class="tab-content mt-2" id="map-tab-content">
                                {% for island_name, plots in plots_by_island.items() %}
                                    <div class="tab-pane fade {% if island_name == current_land_type %}show active{% endif %}" id="map-pane-{{ island_name }}" role="tabpanel" aria-labelledby="map-tab-{{ island_name }}">
                                        <div class="expansion-map-wrapper">
                                            <div class="expansion-map-grid">
                                                {% for plot in plots %}
                                                    <div class="map-plot island-{{ plot.island }} state-{{ plot.state }}" 
                                                         style="grid-area: {{ plot.y }} / {{ plot.x }};"
                                                         title="Lote {{ plot.number }}"
                                                         data-plot-number="{{ plot.number }}"
                                                         data-plot-island="{{ plot.island }}"
                                                         data-plot-state="{{ plot.state }}"
                                                         data-plot-requirements='{{ plot.requirements_data }}'
                                                         data-plot-nodes='{{ plot.nodes_data }}'>
                                                        {{ plot.number }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <div id="map-tooltip-{{ island_name }}" class="map-tooltip" style="display: none;"></div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="map-legend">
                                <div class="legend-item"><span class="legend-color island-basic"></span> Basic</div>
                                <div class="legend-item"><span class="legend-color island-spring"></span> Spring</div>
                                <div class="legend-item"><span class="legend-color island-desert"></span> Desert</div>
                                <div class="legend-item"><span class="legend-color island-volcano"></span> Volcano</div>
                                <div class="legend-item"><span class="legend-color island-swamp"></span> Swamp</div>
                                <div class="legend-item"><span class="legend-color state-locked"></span> Bloqueado</div>

                                {% if in_progress_plot_island %}
                                    <div class="legend-item">
                                        <span class="legend-color state-in_progress island-{{ in_progress_plot_island }}"></span> Em Construção
                                    </div>
                                {% endif %}
                                {% if complete_plot_island %}
                                    <div class="legend-item">
                                        <span class="legend-color state-construction_complete island-{{ complete_plot_island }}"></span> Concluído
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TEMPLATES PARA O PLANEJADOR DE EXPANSÃO -->
<template id="goal-list-template">
    <p class="card-text small text-muted mb-2">
        Plano para Nível <strong data-template="goal-level"></strong> da Ilha <strong data-template="goal-land-type" class="text-capitalize"></strong>:
    </p>
    <div class="d-flex justify-content-around small text-muted border-bottom pb-2 mb-2">
        <span><i class="bi bi-person-check-fill me-1"></i>Nv. Bumpkin: <strong data-template="bumpkin-level"></strong></span>
        <span><i class="bi bi-clock-history me-1"></i>Tempo: <strong data-template="total-time"></strong></span>
    </div>
    <div class="row small text-muted mb-2 text-center">
        <div class="col-6">
            Custo Total: <strong data-template="total-cost"></strong>
        </div>
        <div class="col-6">
            Custo Relativo: <strong data-template="total-relative-cost"></strong>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 pe-md-2"><ul class="list-group list-group-flush" data-column="1"></ul></div>
        <div class="col-md-6 ps-md-2"><ul class="list-group list-group-flush" data-column="2"></ul></div>
    </div>
</template>

<template id="goal-list-item-template">
     <li class="list-group-item d-flex justify-content-between align-items-center compact-list-item px-0">
         <span class="d-flex align-items-center">
             <img src="" alt="" class="me-2 icon icon-2x" data-template="icon">
             <span data-template="name"></span>
         </span>
         <div class="text-end">
             <span class="badge" data-template="shortfall"></span>
             <small class="text-muted d-block" style="font-size: 0.75em;" data-template="value_of_needed"></small>
             <small class="text-muted d-block" style="font-size: 0.75em;" data-template="sfl_value"></small>
         </div>
     </li>
</template>

<template id="unlocks-summary-table-template">
  <div class="mt-4 pt-3 border-top">
    <h6 class="fw-bold mb-2">Desbloqueios e Ganhos na Jornada</h6>
    <div class="table-responsive">
      <table class="table table-sm table-hover small">
        <thead>
            <tr>
                <th style="width: 40px;"></th> {# Coluna vazia para o ícone #}
                <th>Item</th>
                <th class="text-end">Total Ganho</th>
            </tr>
        </thead>
        <tbody data-template="summary-table-body">
          </tbody>
      </table>
    </div>
  </div>
</template>

<template id="unlocks-summary-item-template">
  <tr data-template="item-row">
    <td class="text-center" style="width: 40px;">
        <img src="" alt="" class="icon icon-2x" data-template="icon" onerror="this.style.display='none'">
    </td>
    <td>
        <span data-template="name"></span>
    </td>
    <td class="text-end fw-bold" data-template="total"></td>
  </tr>
</template>