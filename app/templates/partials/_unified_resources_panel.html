<div class="p-3">
    {% if unified_resource_analyses %}
        {% for analysis in unified_resource_analyses %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{{ analysis.title }}</h5>
                </div>
                <div class="card-body p-0">
                    {% for resource_name, resource_data in analysis.resources.items() %}
                        <div class="p-3 border-bottom">
                            <h6 class="mb-2 d-flex align-items-center">
                                <img src="{{ url_for('static', filename=get_item_image_path(resource_name)) }}" class="icon icon-2x me-2" alt="{{ resource_name }}">
                                <span>
                                    {{ resource_name }} ({{ resource_data.summary.total or resource_data.nodes|length }} nós)
                                    {% set prices = resource_name | get_item_prices %}
                                    {% if prices.coins %}
                                        <img src="{{ url_for('static', filename='images/ui/icon_coin.png') }}" class="icon-tiny ms-1" title="Preço de Venda"><small class="text-muted"> {{ "%.4f"|format(prices.coins) }}</small>
                                    {% endif %}
                                    {% if resource_data.summary.total_yield %}
                                        <br><small class="text-muted">Rendimento Total Previsto: <strong>{{ "%.2f"|format(resource_data.summary.total_yield) }}</strong></small>
                                    {% endif %}
                                    {% if resource_data.summary.final_recovery_time %}
                                        <br><small class="text-muted">Tempo Final: <strong>{{ resource_data.summary.final_recovery_time | format_seconds_to_hms }}</strong></small>
                                    {% endif %}
                                </span>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 5%;">ID</th>                                            <th class="text-center" style="width: 10%;">Restantes</th>
                                            <th>Estado</th>
                                            <th class="text-nowrap">Pronto em</th>
                                            <th class="text-nowrap">Rendimento Previsto</th>
                                            <th class="text-center">Crítico</th>
                                            <th class="text-center">Bônus Aplicados (Rendimento / Tempo)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in resource_data.nodes.values() %}
                                        <tr>
                                            <td class="align-middle">#{{ node.id }}</td>
                                            <td class="text-center align-middle">
                                                {% if node.mines_left is defined and node.mines_left is not none %}
                                                    <span class="badge bg-info-subtle text-info-emphasis" title="Minas Restantes">{{ node.mines_left }}</span>
                                                {% elif node.harvests_left is defined and node.harvests_left is not none %}
                                                    <span class="badge bg-success-subtle text-success-emphasis" title="Colheitas Restantes">{{ node.harvests_left }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {% set is_ready = node.state_name in ['Pronta', 'Pronto'] %}
                                                <span class="badge rounded-pill {{ 'bg-success-subtle text-success-emphasis' if is_ready else 'bg-warning-subtle text-warning-emphasis' }}">
                                                    {{ node.state_name }}
                                                </span>
                                            </td>
                                            <td class="text-nowrap align-middle">
                                                {% set remaining = node.ready_at_timestamp_ms | time_remaining %}
                                                {{ remaining }}
                                                {# Mostra a data/hora exata se o item ainda não estiver pronto #}
                                                {% if remaining != 'Pronta' %}<br><small class="text-muted">({{ node.ready_at_timestamp_ms | datetimeformat }})</small>{% endif %}
                                            </td>
                                            <td class="text-nowrap align-middle">
                                                <strong>{{ "%.2f"|format(node.calculations.yield.final_deterministic) }}</strong>
                                                {# Exibe recompensas bônus, se existirem #}
                                                {% if node.bonus_reward %}
                                                    {% for item, amount in node.bonus_reward.items() %}
                                                        <br>
                                                        <small class="text-muted d-flex align-items-center justify-content-end" title="Recompensa Bônus">+{{ amount }}<img src="{{ get_item_image_path(item) }}" class="icon icon-1x ms-1" alt="{{ item }}"></small>
                                                    {% endfor %}
                                                {% endif %}
                                            </td>
                                            <td class="text-center align-middle">
                                                <div class="d-flex flex-column align-items-center gap-1">
                                                {% for crit_name, crit_count in node.critical_hits.items() %}
                                                    {% if crit_count > 0 %}
                                                        <span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle small">{{ crit_name }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                                </div>
                                            </td>                                            <td class="text-center d-flex justify-content-center align-items-center gap-1">
                                                <!-- Popover para Bônus de Rendimento -->
                                                <div class="dropdown">
                                                    <button class="btn btn-outline-info btn-sm py-0 px-2" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Bônus de Rendimento">
                                                        <i class="bi bi-info-circle"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-dark p-2" style="min-width: 250px;">
                                                        <h6 class="dropdown-header px-2">Bônus de Rendimento</h6>
                                                        {% for buff in node.calculations.yield.applied_buffs %}
                                                            <li>
                                                                <span class="dropdown-item-text small text-white">
                                                                    <i class='bi bi-arrow-right-short'></i>
                                                                    <strong>{{ buff.source_item }}:</strong>
                                                                    {% if buff.operation == 'add' %}<span class="text-success fw-bold">+{{ "%.2f"|format(buff.value|float) }}</span>
                                                                    {% elif buff.operation == 'subtract' %}<span class="text-danger fw-bold">-{{ "%.2f"|format(buff.value|float) }}</span>
                                                                    {% elif buff.operation == 'multiply' %}<span class="text-info fw-bold">x{{ buff.value }}</span>
                                                                    {% elif buff.operation == 'percentage' %}<span class="text-{{ 'success' if buff.value > 0 else 'danger' }} fw-bold">{{ "{:+.0%}".format(buff.value) }}</span>
                                                                    {% else %}{{ buff.value }}{% endif %}
                                                                </span>
                                                            </li>
                                                        {% else %}
                                                            <li><span class="dropdown-item-text small text-white-50">Nenhum bônus aplicado.</span></li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>

                                                <!-- Popover para Bônus de Tempo -->
                                                {% set recovery_buffs = node.calculations.recovery.applied_buffs if 'recovery' in node.calculations else node.calculations.growth.applied_buffs %}
                                                <div class="dropdown">
                                                    <button class="btn btn-outline-success btn-sm py-0 px-2" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Bônus de Tempo">
                                                        <i class="bi bi-clock-history"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-dark p-2" style="min-width: 250px;">
                                                        <h6 class="dropdown-header px-2">Bônus de Tempo</h6>
                                                        {% for buff in recovery_buffs %}
                                                            <li>
                                                                <span class="dropdown-item-text small text-white">
                                                                    <i class='bi bi-arrow-right-short'></i>
                                                                    <strong>{{ buff.source_item }}:</strong>
                                                                    {% if buff.operation == 'percentage' %}
                                                                        <span class="text-{{ 'success' if buff.value < 0 else 'danger' }} fw-bold">{{ "{:+.0%}".format(buff.value) }}</span>
                                                                    {% elif buff.operation == 'multiply' %}
                                                                        <span class="text-{{ 'success' if buff.value < 1 else 'danger' }} fw-bold">x{{ "%.2f"|format(buff.value|float) }}</span>
                                                                    {% else %}{{ buff.value }}{% endif %}
                                                                </span>
                                                            </li>
                                                        {% else %}
                                                            <li><span class="dropdown-item-text small text-white-50">Nenhum bônus aplicado.</span></li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">Nenhuma análise de recurso disponível.</div>
    {% endif %}
</div>
