<div id="treasure-dig-panel-wrapper">
{% if treasure_dig_info %}
<div class="row g-4 mt-4">
    <!-- Coluna da Esquerda: Custos, Tesouros e Estatísticas -->
    <div class="col-lg-4 d-flex flex-column gap-4">
        
        <!-- Card de Custos & Tesouros (Condicional) -->
        {% if treasure_dig_info and treasure_dig_info.stats.total_digs > 0 %}
        <div class="card dashboard-card">
            <div class="card-header"><i class="bi bi-gem me-1"></i> Custos & Tesouros</div>
            <div class="card-body">
                <!-- Seção de Custos -->
                <h6><i class="bi bi-tools text-warning me-1"></i> Custos (Ferramentas)</h6>
                <ul class="list-group list-group-flush bg-dark-subtle-item-list">
                     {% for tool, count in treasure_dig_info.stats.tool_usage.items() %}
                     <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-secondary py-1">
                         <span>
                             <img src="{{ url_for('static', filename=get_item_image_path(tool)) }}" class="item-icon-sm me-2" alt="{{ tool }}">
                             {{ tool }}
                         </span>
                         <span class="badge bg-secondary rounded-pill">{{ count }}</span>
                     </li>
                     {% else %}
                     <li class="list-group-item bg-transparent border-secondary py-1">Nenhuma ferramenta usada.</li>
                     {% endfor %}
                 </ul>

                <!-- Seção de Tesouros -->
                <h6 class="mt-3"><i class="bi bi-treasure-chest-fill text-info me-1"></i> Tesouros (Lucro)</h6>
                <ul class="list-group list-group-flush bg-dark-subtle-item-list">
                    {% for item, count in treasure_dig_info.stats.items_found.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-secondary py-1">
                        <span>
                            <img src="{{ url_for('static', filename=get_item_image_path(item)) }}" class="item-icon-sm me-2" alt="{{ item }}">
                            {{ item }}
                        </span>
                        <span class="badge bg-secondary rounded-pill">{{ count }}</span>
                    </li>
                    {% else %}
                    <li class="list-group-item bg-transparent border-secondary py-1">Nenhum item encontrado.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- Card de Estatísticas Gerais -->
        <div class="card dashboard-card">
            <div class="card-header"><i class="bi bi-bar-chart-line-fill me-1"></i> Estatísticas Gerais</div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><strong>Total de Escavações:</strong> {{ treasure_dig_info.stats.total_digs }}</li>
                    <li><strong>Sequência Atual:</strong> {{ treasure_dig_info.stats.streak.count | default('N/A', true) }}</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Coluna Central: Grid de Escavação -->
    <div class="col-lg-4">
        <div class="card dashboard-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-grid-3x3-gap-fill me-1"></i> Grid de Escavação</span>
                <!-- Botão para mostrar/esconder o painel de dicas flutuante -->
                {% if treasure_dig_info and treasure_dig_info.hints %}
                <button type="button" class="btn btn-warning btn-sm" id="toggle-hints-balloon-btn">
                    <i class="bi bi-lightbulb icon-off me-1"></i>
                    <i class="bi bi-lightbulb-fill icon-on me-1"></i>
                    <span class="button-text">Ver Dicas</span>
                </button>
                {% endif %}
                <div class="btn-group btn-group-sm">
                    <button id="update-treasure-dig-btn" class="btn btn-outline-secondary" title="Atualizar dados" data-farm-id="{{ farm_id }}">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="cooldown-timer d-none ms-1"></span>
                    </button>
                </div>
            </div>
            <div class="card-body d-flex flex-column justify-content-start align-items-center">
                <div class="treasure-grid-wrapper position-relative">
                    <!-- Grid de Escavação -->
                    {% if treasure_dig_info and treasure_dig_info.stats.total_digs > 0 %}
                        <!-- Eixo Y (vertical) -->
                        <div class="treasure-grid-axis treasure-grid-axis-y">
                            {% for i in range(10) %}<span>{{ i }}</span>{% endfor %}
                        </div>
                        <!-- Eixo X (horizontal) -->
                        <div class="treasure-grid-axis treasure-grid-axis-x">
                            {% for i in range(10) %}<span>{{ i }}</span>{% endfor %}
                        </div>
                        <div class="treasure-grid">
                            {% for y, row in enumerate(treasure_dig_info.grid_mirror) %}
                                {% for x, cell in enumerate(row) %}
                                <div class="treasure-grid-cell" data-x="{{ x }}" data-y="{{ y }}">
                                    {% if cell %}
                                    <img src="{{ url_for('static', filename=cell.image) }}" alt="{{ cell.item_name }}" title="{{ cell.item_name }}" class="treasure-grid-item-icon">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    {% else %}
                    <div class="treasure-grid-placeholder d-flex flex-column justify-content-center align-items-center h-100 p-3 text-center">
                        <h5 class="text-success mb-3"><i class="bi bi-info-circle me-1"></i> Como Funciona</h5>
                        <ol class="list-unstyled text-start small" style="line-height: 1.9;">
                            <li class="mb-2"><span class="badge bg-secondary me-2">1</span> <strong>Cave no Jogo:</strong> Use suas ferramentas na Ilha do Deserto.</li>
                            <li class="mb-2"><span class="badge bg-secondary me-2">2</span> <strong>Atualize os Dados:</strong> Clique no botão <i class="bi bi-arrow-clockwise"></i> acima.</li>
                            <li class="mb-2"><span class="badge bg-secondary me-2">3</span> <strong>Veja seu Grid:</strong> Suas escavações aparecerão aqui.</li>
                            <li><span class="badge bg-secondary me-2">4</span> <strong>Receba Dicas:</strong> Com mais escavações, o painel dará dicas sobre os padrões!</li>
                        </ol>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Coluna da Direita: Padrões -->
    <div class="col-lg-4">
        <div class="card dashboard-card h-100">
            <div class="card-header"><i class="bi bi-bullseye me-1"></i> Objetivos</div>
            <div class="card-body">
                <h6>Padrões Atuais</h6>
                {% if treasure_dig_info.patterns.current %}
                <div class="treasure-patterns-container">
                    {# Loop através dos padrões atuais para desenhar os mini-grids #}
                    {% for pattern in treasure_dig_info.patterns.current %}
                    {# Adiciona a classe 'is-completed' se o padrão estiver concluído #}
                    <div class="treasure-pattern-item {% if pattern.is_completed %}is-completed{% endif %}" title="{{ pattern.name }}">
                        {% if pattern.grid_data.mini_grid %}
                        {# Define uma variável CSS com o tamanho do grid, mantendo o CSS separado #}
                        <div class="pattern-mini-grid">
                            {% for row in pattern.grid_data.mini_grid %}
                                {% for cell in row %}
                                    <div class="pattern-mini-grid-cell">
                                        {% if cell %}
                                            <img src="{{ url_for('static', filename=cell.image) }}" alt="{{ cell.item_name }}" title="{{ cell.item_name }}" class="pattern-mini-grid-icon">
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                                    <span class="pattern-mini-grid-name">{{ pattern.name }}</span>
                        {% else %}
                        {# Fallback para imagem se o padrão não estiver definido no backend #}
                        <img src="{{ url_for('static', filename=pattern.image) }}" alt="{{ pattern.name }}">
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small">Nenhum padrão ativo.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
    <div class="alert alert-warning mt-4" role="alert">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Erro ao Carregar Dados de Escavação</h5>
        <p>Não foi possível analisar os dados de escavação da sua fazenda. Isso pode ocorrer devido a um erro temporário ou a dados corrompidos no seu ficheiro de save.</p>
        <hr>
        <p class="mb-0">Tente atualizar os dados novamente. Se o problema persistir, verifique a consola do terminal para mais detalhes sobre o erro original.</p>
    </div>
{% endif %}

<!-- Balão de Dicas Flutuante e Retrátil (desconectado do layout) -->
{% if treasure_dig_info and treasure_dig_info.hints %}
<div class="floating-hints-balloon d-none" id="hints-balloon">
    <div class="hints-header" id="hints-balloon-header">
        <h6 class="mb-0 text-warning"><i class="bi bi-lightbulb-fill me-2"></i>Dicas e Pistas</h6>
    </div>
    <div class="hints-body">
        <div class="accordion accordion-flush" id="hints-accordion">
                {% for hint_group in treasure_dig_info.hints %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
                                {{ hint_group.pattern_name }}
                            </button>
                        </h2>
                        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#hints-accordion">
                            <div class="accordion-body">
                                <ul class="list-group list-group-flush small">
                                    {% for hint in hint_group.possible_locations %}
                                        <li class="list-group-item bg-transparent border-secondary py-1 d-flex align-items-start" data-highlight-coords="{{ hint.highlight_coords | safe }}">
                                            <i class="bi bi-pin-map-fill text-success me-2 mt-1"></i>
                                            <span>{{ hint.text }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endfor %}
        </div>
    </div>
</div>
{% endif %}
</div>
